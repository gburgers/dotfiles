#!/bin/bash
# ~/bin/backup-toolboxes.sh
# Backup multiple toolboxes to tar files (only if changed)

DATE=$(date +%Y%m%d)
BACKUP_DIR="$HOME/data/_BACKUPS/toolboxes"
CHECKSUM_DIR="$BACKUP_DIR/.checksums"
mkdir -p "$BACKUP_DIR" "$CHECKSUM_DIR"

# List of toolboxes to backup
TOOLBOXES=("go-dev" "cli-tools")

echo "Starting toolbox backup for $(date)..."
echo "Backup directory: $BACKUP_DIR"
echo ""

for toolbox in "${TOOLBOXES[@]}"; do
  echo "Processing toolbox: $toolbox"

  # Check if toolbox exists
  if ! toolbox list | grep -q "$toolbox"; then
    echo "  ‚ö†Ô∏è  Toolbox '$toolbox' not found, skipping..."
    continue
  fi

  # Get container ID and calculate checksum of its state
  CONTAINER_ID=$(podman ps -a --filter "name=$toolbox" --format "{{.ID}}")
  if [ -z "$CONTAINER_ID" ]; then
    echo "  ‚ö†Ô∏è  Could not find container ID for $toolbox, skipping..."
    continue
  fi

  # Create a checksum based on container's filesystem changes and metadata
  CURRENT_CHECKSUM=$(podman diff "$CONTAINER_ID" 2>/dev/null | sort | sha256sum | cut -d' ' -f1)
  CHECKSUM_FILE="$CHECKSUM_DIR/$toolbox.checksum"

  # Check if we have a previous checksum
  if [ -f "$CHECKSUM_FILE" ]; then
    PREVIOUS_CHECKSUM=$(cat "$CHECKSUM_FILE")
    if [ "$CURRENT_CHECKSUM" = "$PREVIOUS_CHECKSUM" ]; then
      echo "  ‚è≠Ô∏è  No changes detected in $toolbox, skipping backup"
      echo ""
      continue
    else
      echo "  üîÑ Changes detected in $toolbox"
    fi
  else
    echo "  üÜï First backup for $toolbox"
  fi

  # Create image name and backup
  IMAGE_NAME="backup-$toolbox:latest"
  TAR_FILE="$BACKUP_DIR/$toolbox-backup-latest.tar"

  # Remove old image if it exists
  podman rmi "$IMAGE_NAME" 2>/dev/null || true

  echo "  üì¶ Committing $toolbox to image $IMAGE_NAME..."
  if podman commit "$toolbox" "$IMAGE_NAME"; then
    echo "  üíæ Saving image to $TAR_FILE..."
    if podman save "$IMAGE_NAME" -o "$TAR_FILE"; then
      echo "  ‚úÖ Successfully backed up $toolbox"

      # Save the new checksum
      echo "$CURRENT_CHECKSUM" >"$CHECKSUM_FILE"

      # Show file size and date
      SIZE=$(du -h "$TAR_FILE" | cut -f1)
      echo "  üìä Backup size: $SIZE"
      echo "  üìÖ Last updated: $(date)"
    else
      echo "  ‚ùå Failed to save $toolbox image"
    fi
  else
    echo "  ‚ùå Failed to commit $toolbox"
  fi
  echo ""
done

echo "Backup completed!"
echo ""

# Rsync to USB backup drive
USB_MOUNT="/run/media/gerben/Backup"
USB_BACKUP_DIR="$USB_MOUNT/_BACKUPS/toolboxes"

if [ -d "$USB_MOUNT" ] && [ -w "$USB_MOUNT" ]; then
  echo "üì° Syncing backups to USB drive..."
  mkdir -p "$USB_BACKUP_DIR"

  if rsync -av --delete "$BACKUP_DIR/" "$USB_BACKUP_DIR/"; then
    echo "‚úÖ Successfully synced to USB backup drive"

    # Show total backup size on USB
    USB_SIZE=$(du -sh "$USB_BACKUP_DIR" 2>/dev/null | cut -f1)
    echo "üìä Total USB backup size: $USB_SIZE"
  else
    echo "‚ùå Failed to sync to USB backup drive"
  fi
else
  echo "‚ö†Ô∏è  USB backup drive not available at $USB_MOUNT"
  echo "   Local backups saved to: $BACKUP_DIR"
fi

echo ""
echo "To restore a toolbox:"
echo "  podman load -i $BACKUP_DIR/TOOLBOX-backup-latest.tar"
echo "  toolbox create --image backup-TOOLBOX:latest TOOLBOX-restored"

# Backup dotfiles with backup-dotfiles script
echo ""
echo "Starting dotfiles backup..."
~/.local/bin/backup-dotfiles
